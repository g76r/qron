<!DOCTYPE html>
<!--
 Copyright 2016 Hallowyn and others.
 This file is part of qron, see <http://qron.eu/>.
 Qron is free software: you can redistribute it and/or modify
 it under the terms of the GNU Affero General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 Qron is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU Affero General Public License for more details.
 You should have received a copy of the GNU Affero General Public License
 along with qron. If not, see <http://www.gnu.org/licenses/>.
-->
<?include:header.html?>

      <div class="row">
        <div class="col-md-3">
          <nav class="hidden-print hidden-xs hidden-sm affix manual-sidebar" id="navbar-manual">
            <p><ul class="nav">
              <li><a href="#">Introduction</a>
              <li><a href="#concepts">Concepts</a>
              <li><a href="#tasks-hierarchy">Tasks Hierarchy</a>
              <ul class="nav">
                <li><a href="#task-groups">Task Groups</a>
                <li><a href="#tasks">Tasks</a>
                <ul class="nav">
                  <li><a href="#tasks-description">Description</a>
                  <li><a href="#tasks-execution-properties">Execution Properties</a>
                  <li><a href="#tasks-triggers-and-constraints">Triggers and Constraints</a>
                  <li><a href="#tasks-parameters">Parameters</a>
                  <li><a href="#tasks-setenvs">Setenvs</a>
                  <li><a href="#tasks-events-subscriptions">Events Subscriptions</a>
                  <li><a href="#tasks-monitoring">Monitoring</a>
                  <li><a href="#tasks-request-forms">Request Forms</a>
                </ul>
                <li><a href="#workflows-and-subtasks">Wokflows and Subtasks</a>
              </ul>
              <li><a href="#infrastructure">Infrastructure</a>
              <ul class="nav">
                <li><a href="#hosts">Hosts</a>
                <li><a href="#clusters">Clusters</a>
              </ul>
              <li><a href="#logs">Logs</a>
              <ul class="nav">
                <li><a href="#logs-configuration">Configuration</a>
                <li><a href="#centralizing-logging-of-tasks-stderr">Centralizing Logging of Tasks Stderr</a>
                <li><a href="#logs-format">Logs Format</a>
                <li><a href="#logs-rotation">Logs Rotation</a>
              </ul>
              <li><a href="#alerts">Alerts</a>
              <ul class="nav">
                <li><a href="#stateful-alerts">Stateful Alerts</a>
                <li><a href="#one-shot-alerts">One-Shot Alerts</a>
                <li><a href="#alert-channels">Alert Channels</a>
                <li><a href="#alerts-subscriptions">Subscriptions</a>
                <li><a href="#automatic-alerts">Automatic Alerts</a>
                <li><a href="#custom-alerts">Custom Alerts</a>
                <li><a href="#gridboards">Gridboards</a>
                <li><a href="#alerts-fine-tuning">Fine Tuning</a>
              </ul>
              <li><a href="#events-and-actions">Events and Actions</a>
              <ul class="nav">
                <li><a href="#task-level-events">Task-Level Events</a>
                <li><a href="#scheduler-level-events">Scheduler-Level Events</a>
                <li><a href="#actions">Actions</a>
                <li><a href="#notices">Notices</a>
              </ul>
              <li><a href="#resources">Resources</a>
              <li><a href="#parameters">Parameters</a>
              <ul class="nav">
                <li><a href="#hierarchical-inheritance-of-parameters-set">Hierarchical Inheritance</a>
                <li><a href="#percent-evaluation">%-Evaluation</a>
                <li><a href="#special-parameters">Special Parameters</a>
              </ul>
              <li><a href="#configuration-management">Configuration Management</a>
              <li><a href="#operations">Operations</a>
              <ul class="nav">
                <li><a href="#task-instances-lifecycle">Task Instances Lifecycle</a>
                <ul class="nav">
                  <li><a href="#task-instances-statuses">Statuses</a>
                  <li><a href="#task-instances-timestamps-and-durations">Timestamps and Durations</a>
                  <li><a href="#task-instances-success-conditions">Success Conditions</a>
                </ul>
                <li><a href="#actions-performed-by-an-operator">Actions Performed by an Operator</a>
              </ul>
              <li><a href="#wui">Web User Interface</a>
              <ul class="nav">
                <li><a href="#wui-description">Description</a>
                <li><a href="#wui-views">Views</a>
                <li><a href="#wui-customization">Customization</a>
              </ul>
              <li><a href="#http-api">HTTP API (REST API)</a>
              <ul class="nav">
                <li><a href="#rest-api">REST API</a>
                <li><a href="#rpc-api">RPC API</a>
              </ul>
              <li><a href="#appendices">Appendices</a>
              <ul class="nav">
                <li><a href="#configuration-file-format">Configuration File Format</a>
                <li><a href="#configuration-examples">Configuration Examples</a>
                <li><a href="#linux-integration">Linux Integration</a>
              </ul>
            </ul>
          </nav>
        </div>
        <div class="col-md-9 user-manual" data-spy="scroll" data-target="navbar-manual" data-offset="0">

<h1>Qron User Manual</h1>

<p>This web page is the user manual of <a href="http://qron.eu/">qron</a> free
scheduler.

<p>It can be read both in qron web user interface (embeded in qron daemon)
and on the Internet here:
<a href="http://qron.eu/doc/master/user-manual.html">http://qron.eu/doc/master/user-manual.html</a>.

<p>You are currently reading this version of the documentation:
<?include:version.txt?>

<h2>Concepts</h2>

<p>Qron is a task scheduler, that is, a software controlling execution of
non-interactive application components such as large batches planned once a
day, automatic processing of incoming messages every minute, or any
processing triggered by an event not directly issued by a human being.

<p>This implies <a href="#tasks-hierarchy">defining tasks</a>, the way they are
<a href="#tasks-triggers-and-constraints">triggered</a>, the properties of the
<a href="#infrastructure">infrastructure</a> on which they run, alongside
with <a href="#logs">centralized logs</a> and <a href="#alerts">alert means</a>
to notify about anything wrong or suspect.

<p>Often, scheduling tasks will also need a powerful parameters system with
<a href="#hierarchical-inheritance-of-parameters-sets">hierarchical
inheritance</a> and <a href="#percent-evaluation">evaluation language</a>,
handling scheduling <a href="#tasks-triggers-and-constraints">constraints</a>
such as <a href="#resources">resources</a> and
<a href="#calendars">calendars</a>, or a customizable
<a href="#events-and-actions">event-driven model</a>.

<p>Monitoring and operating the scheduler can be done through the
<a href="#wui">responsive-design web user interface</a> and (coming soon)
desktop and phone/tablet apps.

<p>Integrating with other IT tools and custom extensions is possible through
<a href="#http-api">HTTP API</a> and <a href="#linux-integration">standard
operating system integration</a>.

<h2>Tasks Hierarchy</h2>

<p>Tasks are grouped within taskgroups in a tree hierarchy.
In addition, workflow tasks have subtasks.

<p>Sample trigger diagram with 5 tasks within 2 task groups:
<img class="img-responsive center-block"
src="img/trigger-diagram-sample.svg"
title="Sample trigger diagram with 5 tasks within 2 task groups" />

<h3>Task Groups</h3>

<p>Tasks are grouped within taskgroups which make the configuration
more clear in a documentation point of view (when used to group tasks
e.g. by application or module) and/or by factorizing some task
properties (such as <a href="#parameters">paremeters</a> and
<a href="#events">events</a>).

<p>A taskgroup consist of its id (which is its only mandatory
field), plus optional fields: a human readable <tt>label</tt>
and task properties that are inherited by any task belonging
to the group. The task properties that can be defined at the
taskgroup level are <a href="#tasks-parameters"><tt>params</tt></a>,
<a href="#tasks-setenvs"><tt>setenv</tt> and <tt>unsetenv</tt></a>
and <a href="#tasks-events-and-actions">events subscriptions</a>.

<p>There is only one level of taskgroups (a taskgroup cannot
belong to another taskgroup) however dots in taskgroups id
are processed as a hierarchical separator by qron user interfaces
to display a multi-level tree.

<p>Sample configuration file fragments:
<pre>
(taskgroup app1.biz.batch
  (label business batches for application app1)
)
</pre>
<pre>
(taskgroup app2.tech
  (label technical tasks for application app2)
  (param db_password mysecret)
  (setenv ORACLE_SID ORCL)
)
</pre>
<pre>
(taskgroup minimalgroup)
</pre>

<h3>Tasks</h3>

<p>Task is qron's most important configuration element. It carries almost
every information needed to schedule and execute a task and often some of
the event and alerting configuration is done task by task.

<h4>Tasks Description</h4>

<p>A task is described by its id and its parent <tt>taskgroup</tt>.
It should also have a human readable <tt>label</tt> and some additional
documentation <tt>info</tt>.

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (label "build PDF reports about customers")
  (info "see http://intranet/app1/ReportingBatches")
)
</pre>
<pre>
(task oracle-statistics
  (taskgroup app2.tech)
  (label recompute statistics for db ORCL)
)
</pre>
<pre>
(task minimaltask(taskgroup minimalgroup))
</pre>

<h4>Tasks Execution Properties</h4>

<p>Task execution is defined by 3 properties:
<ul>
  <li><tt>mean</tt>: describes the mean used to execute the task, among the following:
  <ul>
    <li><tt>local</tt>: spawn a process local to the qron daemon, on the same
    host
    <li><tt>ssh</tt>: establish an SSH connection to the target host to
    execute the task
    <li><tt>http</tt>: perform an HTTP request
    <li><tt>workflow</tt>: start a workflow consisting of one or several
    subtasks conditionaly linked together with transitions, each of them having
    their own execution properties, see
    <a href="#workflows-and-subtasks">workflows</a> section below
    <li><tt>donothing</tt>: do not execute anything, but still trigger events,
    pretending the execution to be successful (i.e. <tt>onsuccess</tt> actions
    will be triggered, not <tt>onfailure</tt> ones)
  </ul>
  <li><tt>target</tt>: defines which <tt>host</tt> or <tt>cluster</tt> will be
    choosen to execute the task, defaults to <tt>localhost</tt>, see
    <a href="#infrastructure">infrastructure</a> section for more details
  <li><tt>command</tt>: interpreted depending on the execution mean:
  <ul>
    <li><tt>local</tt> and <tt>ssh</tt> means: command line, spaces being
    interpreted as command arguments separators but if they are protected
    by backslashes
    <li><tt>http</tt> mean: path and query string
    <li><tt>workflow</tt> and <tt>donothing</tt> means: not applicable, should
    be omitted
  </ul> 
</ul>

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (mean ssh)
  (target server1)
  (command /opt/app1/bin/build_reports.sh --customers)
)
</pre>
<pre>
(task process-last-orders
  (taskgroup app1.biz.queuing)
  (mean http)
  (target server4)
  (command /pollers/last-orders/?from=-5minutes)
  (param method POST) # defaults to GET
  (param user scheduler) # set up a "Authorization: Basic" header
  (param password mysecret)
)
</pre>
<pre>
(task remove-old-files
  (taskgroup app1.tech)
  (mean ssh)
  (target server1)
  (command bash -c '
# shell script right in qron config file
set -e
for DIR in %directories; do
  find $DIR -mtime +60 -delete
done
')
  (param directories /opt/app1/files /opt/app1/backup /tmp/app1)
)
</pre>

<h4>Tasks Triggers and Constraints</h4>

<p>Tasks are queued for execution when triggered, and one can defined one or
several triggers among:
<ul>
<li><tt>cron</tt>: time trigger in the form of Unix' cron pattern with precision
down to second, e.g.
  <ul>
  <li><tt>* * * * * *</tt>: every seconds
  <li><tt>13 6 7 * * 1</tt>: every monday (1) at 07:06:13 in the morning 
  <li><tt>/15 * 8-20 * * *</tt>: every 15 seconds from 8 a.m. to 8 p.m.
  </ul>
<li><tt>notice</tt>: event trigger that happen when a given
<a href="#notices">notice event</a> occurs
<li><tt>filechange</tt>: not yet implented, but will be able to trigger task
execution on local or remote file change or creation
<li>HTTP API: a task can be triggered by <a href="#http-api">HTTP API</a>
<a href="#requesttask-call"><tt>requesttask</tt> call</a>
<li><tt>requesttask</tt> event: a task can be triggered by occurrence of a
<a href="#events"><tt>requesttask</tt> event</a>
</ul>

<p>TODO: calendars

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (trigger(cron 0 0 23 * * 1-6)) # 23:00 mon-sat
)
</pre>
<pre>
(task process-last-orders
  (taskgroup app1.biz.queuing)
  (trigger
    (cron /15 * 8-20 * * *) # every 15 seconds daily
    (cron 0 0 22 * * * # once in the evening
      (param mode nightly) # overriding parameter 'mode'
    )
    (notice process-last-orders-now) # on event
  )
)
</pre>

<p id="maxinstances">When a task is queued for execution, it will be executed only when
no constraint disable the task from running. Contraints are of several types:
<ul>
<li><tt>maxinstances</tt>: a given task is only allowed to be run
<tt>maxinstances</tt> times at a time, which defaults to 1
<li><tt>resources</tt>: if a given task is declared to need some
<tt>resources</tt> it can only run on its target <tt>host</tt> if it has
enough resources available, resources can be seen as semaphores, and can be
used for mutual exclusion across tasks, see <a href="#resources">resources</a>
section below.
</ul>

<p>Sample configuration file fragments:
<pre>
(task process-customer-request
  (taskgroup app1.biz.queuing)
  (maxinstances 16) # code is multiexec-safe and is faster when parallelized
)
</pre>
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (target report-server)
  (resource memory 2048) # avoid too many memory consummers on the server
  (resource reports-semaphore 1) # avoid two report batches running at a time
)
(host report-server
  (hostname server4.acme.com)
  (resource memory 8192)
  (resource reports-semaphore 1)
)
</pre>

<p id="enqueuepolicy">
In addition, tasks can be rejected when submitted for queueing, and queued
tasks can even be automaticaly canceled, according to <tt>enqueuepolicy</tt>,
which is defined task by task and can have the following values/behaviors:
<ul>
<li><tt>enqueueanddiscardqueued</tt>: when a task is queued, every other
queued task with the same id is canceled, avoiding stacking tasks in big
numbers when they are slower than expected, this is the default
<li><tt>enqueueall</tt>: allow boundless stacking of this task in the queue,
provided the queue limit is not reached <br/><i class="icon-warning"></i>
warning: when the queue limit is reached, <em>other</em> tasks may be
rejected, so this setting is dangerous for the whole tasks schedule
<li><tt>enqueueuntilmaxinstances</tt>: reject task requests when task
<tt>maxinstances</tt> is already reached by running instances + queued ones,
this can be convenient for user-requested tasks since it's no longer possible
to request execution of a task that is already running and is set to
maxinstances = 1 (which is the default)

</ul>
<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (enqueuepolicy enqueueuntilmaxinstances)
)
</pre>

<h4>Tasks Parameters</h4>

<p>Tasks have free text parameters defined by <tt>param</tt> configuration
element. They can be used for any custom parameters and are evaluated
with <tt>%</tt> evaluation character in many other configuration items.

<p>The whole system for parameters evaluation and inheritance is discussed in
deep in <a href="#parameters">parameters</a> section below alonside with
special parameters name that have an effect qron behavior (parameters such as
<tt>ssh.options</tt> when using ssh execution mean).

<p>Parameters can be overriden at task request, being it in trigger definition,
in <a href="#http-api">HTTP API</a> or in web user interface using
<a href="#tasks-request-forms">request forms</a>.

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (mean ssh)
  (target server1)
  (command /opt/app1/bin/build_reports.sh --customers --from %from)
  (param from -2days) # regular param value
  (trigger
    (cron 0 0 23 * * 1-6)
    (cron 0 0 23 * * 0 (param from -8days)) # different param on sunday
  )
  (requestform
    (field from # can be overriden when the task is started from the web ui
      (label Data depth) # ui label
      (placeholder -2days) # ui placeholder/hint
      (format "-[0-9]+days") # server side validation regexp
    )
  )
)
</pre>

<h4>Tasks Setenvs</h4>

<p>Depending on the execution <tt>mean</tt>, there can be out of band
parameters, transmitted by another way than the <tt>command</tt> itself.
For <tt>local</tt> and <tt>ssh</tt> means this is possible through
environment variables (hence the name <tt>setenv</tt>).
For <tt>http</tt> mean this is possible through custom HTTP headers.

<p>These out of band parameters are defined and removed using two configuration
elements: <tt>setenv</tt> and <tt>unsetenv</tt>.

<p>TODO: explain how default envionment is set, according to execution mean.

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (mean ssh)
  (target server1)
  (command /opt/app1/bin/build_reports.sh --customers)
  (setenv ORACLE_SID ORCL)
)
</pre>

<pre>
(task process-last-orders
  (taskgroup app1.biz.queuing)
  (mean http)
  (target server4)
  (command /pollers/last-orders/?from=-5minutes)
  (setenv X-TaskInstanceId %!taskinstanceid)
  (setenv Authorization Basic AhjsqduYez=)
  #in fact it's often easier to set Authorization header this way:
  #(param user scheduler) # set up a "Authorization: Basic" header
  #(param password mysecret)
)
</pre>

<h4>Tasks Events Subscriptions</h4>

<p>Several task-level events can be used to define actions at task (or
taskgroup) level. See <a href="#task-level-events">Task-Level Events</a>
section below for more details.

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (onsuccess
    # sending UDP packets to statsd server, see https://github.com/etsy/statsd
    (requesturl "task.%!taskid.ok:1|c" (address udp://127.0.0.1:8125))
    (requesturl (address udp://127.0.0.1:8125) "task.%!taskid.time:%!totalms|ms")
    # add a custom debug log for task success
    (log(severity debug) task success! *%!tasklocalid*)
  )
  (onfailure
    # sending UDP packets to statsd
    (requesturl(address udp://127.0.0.1:8125) "task.%!taskid.ko:1|c")
  )
)
</pre>

<h4>Tasks Monitoring</h4>

<p>Whenever a task has a suspect behavior, the scheduler emit an
<a href="#automatic-alerts">automatic alert</a>. For instance when a task
finishes with a failure status.

<p>It's often a good idea to send by e-mail (or any other mean) the automatic
alerts for all or most of the tasks in order to be notified of an issue.
See <a href="#alerts-subscriptions">alerts subscriptions</a> section below.

<p>More automatic alerts are available when setting the following task
parameters:
<ul>
<li><tt>minexpectedduration</tt>: minimum expected task
<a href="#task-instances-timestamps-and-durations">running duration</a> in
seconds, an alert will be raised otherwise, with the pattern
<tt>task.tooshort.%!taskid</tt>, the alert is raised when the task finishes.
<li><tt>maxexpectedduration</tt>: maximum expected task 
<a href="#task-instances-timestamps-and-durations">total duration</a> in
seconds, an alert will be raised otherwise, with the pattern
<tt>task.toolong.%!taskid</tt>, the alert is raised as soon as the task is
running longer than maxexpectedduration (although the detection may take up to
1 minute it won't wait for the task finishing).
<li><tt>maxdurationbeforeabort</tt>:
<a href="#task-instances-timestamps-and-durations">total duration</a> above
which the scheduler will
<a href="#actions-performed-by-an-operator">abort</a> a running task,
this is useful for certain kind of tasks that should better be killed that take
too much time (a nightly purge that can disrupt normal daily processing, a
periodic task running every minutes that should rather be killed when frozen
after 3 minutes rather than keep disable next executions forever, etc.) but is
dangerous in many other cases since aborting is quite hard (kill for local and
ssh execution means, close for http execution mean).
</ul>

<p>Task duration is the time elapsed between the queuing of a task request and
the finishing of its execution.

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (minexpectedduration 10) # below 10" there is a issue with data selected
  (maxexpectedduration 3600) # 1 hour
)
</pre>
<pre>
(task process-last-orders
  (taskgroup app1.biz.queuing)
  (trigger(cron /30 * 8-20 * * *)) # twice a minute
  (maxexpectedduration 20)
  (maxdurationbeforeabort 300) # 5 minutes
)
</pre>

<h4>Tasks Request Forms</h4>

<p>When a user task execution request is submited interactively through the
<a href="#wui">web user interface</a> (or, when it will be available, the
desktop/phone user interface) it is possible to display a custom
form to ask the user which <a href="#tasks-parameters">parameters</a> he
would like to override.

<p>A request form is described in the configuration file using a
<tt>requestform</tt> element within a task declaration. It contains one
<tt>field</tt> elements per form field, which itself can contain
the following optional elements:
<ul>
<li><tt>label</tt>: user interface label (field title)
<li><tt>placeholder</tt>: user interface hint (<tt>placeholder</tt> attribute
of <tt>input</tt> HTML element)
<li><tt>suggestion</tt>: default value
<li><tt>format</tt>: validation regular expression (for the web user interface,
the validation is enforced server-side)
</ul>

<p>Sample configuration file fragment:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (command "/opt/app1/bin/build_reports.sh --customers --from %from
     %{=switch:%dryrun:true:--dryrun:}")
  (param from -2days) # regular param value
  (requestform
    (field from # can be overriden when the task is started from the web ui
      (label Data depth) # ui label
      (placeholder -2days) # ui placeholder/hint
      (format "-[0-9]+days") # server side validation regexp
    )
    (field dryrun
      (label Dry run)
      (suggestion false) # default value in ui form
      (format "true|false")
    )
  )
)
</pre>

<h3>Workflows and Subtasks</h2>

TODO

<h2>Infrastructure</h2>

<p>Tasks are executed on hosts, optionaly grouped by clusters.

<p>Sample deployment diagram with 5 tasks deployed on 1 cluster and 3 hosts:
<img class="img-responsive center-block"
src="img/deployment-diagram-sample.svg"
title="Sample deployment diagram with 5 tasks deployed on 1 cluster and 3 hosts" />

<h3>Hosts</h3>

<p>A <tt>host</tt> is an execution target for tasks.
It must have an <tt>id</tt> and, for most execution means, a <tt>hostname</tt>
(which default value is the <tt>id</tt>).
A host can also carry an optional human readable <tt>label</tt> and
<tt>resources</tt> that are consummed by tasks that need them, see
<a href="#resources">resources</a> section below

<p>The same <tt>host</tt> can be used by several execution <tt>means</tt>,
for instance one can defines http and ssh tasks with the same host as target
provided both means can use the same hostname to reach the host.

<p>There must always be a host named <tt>localhost</tt>. If it's not declared
in configuratio file, qron will pretend it is declared with no other
property than its id.

<p>Sample configuration file fragments:
<pre>
(host server1
  (hostname server1.mycompany.com)
  (resource memory 8192)
)
</pre>
<pre>
(host localhost)
</pre>

<h3>Clusters</h3>

<p>A <tt>cluster</tt> defines an execution target consisting of a list of
<tt>hosts</tt> and a <tt>balancing</tt> method to choose the actual execution
host among them. It must have an <tt>id</tt>, which cannot be identical to
one of the hosts id, and can have a human readable <tt>label</tt>.

<p>Following <tt>balancing</tt> methods are supported:
<ul>
<li><tt>first</tt>: choose first host (in configuration order) with enough
resources
<li><tt>random</tt>: choose a random host among those with enough resources
<li><tt>roundrobin</tt>: choose clusters hosts one after another, skipping
hosts without enough resources, this is the default balancing method
<li><tt>each</tt>: when requesting the task once, it is actually executed
on every host within the cluster
</ul>

<p>Sample configuration file fragments:
<pre>
(cluster app-servers
  (hosts server1 server2 server3)
  (balancing roundrobin) # this can be omitted since this is the default
)
(task process-last-orders
  (taskgroup app1.biz.queuing)
  (mean http)
  (target app-servers)
  (command /pollers/last-orders/?from=-5minutes)
)
</pre>
<pre>
(cluster unix-servers
  (hosts server4 server5 server6)
  (balancing each)
)
(task remove-old-files-on-every-unix-server
  (taskgroup app1.tech)
  (mean ssh)
  (target unix-servers)
  (command find /opt/app1/files -mtime +60 -delete)
  (maxinstances 3) # allow parallel execution on 3 hosts
)
</pre>

<h2>Logs</h2>

<p>Qron logs information related to tasks scheduling and exectution,
configuration changes, web ui user interaction, etc.
In addition it also logs error messages from tasks themselves when the
execution mean make it possible, which is a simple way to centralize tasks
logs.

<h3>Logs Configuration</h3>

<p>Several log files can be defined in the configuration file with <tt>log</tt>
element, which must have following properties:
<ul>
<li><tt>file</tt>: path to the log file, which is
<a href="#percent-evaluation">%-evaluated</a> and thus can vary depending on
the date <li><tt>level</tt>: minimal severity level to log, among
<tt>debug</tt>, <tt>info</tt>, <tt>warning</tt>, <tt>error</tt> and
<tt>fatal</tt>
</ul>

<p>The <tt>log</tt> element can also have a <tt>unbuffered</tt> flag to disable
write buffers.

<p>Sample configuration file fragments:
<pre>
(log(level debug)(file "/var/log/qron/debug-%{=date:yyyyMMdd}.log"))
(log(level info)(file "/var/log/qron/info-%{=date:yyyyMMdd}.log"))
</pre>
<pre>
(log(level debug)(file "/tmp/qron-debug.log")(unbuffered))
</pre>

<h3>Centralizing Logging of Tasks Stderr</h3>

<p>Qron automatically records in its logs the standard error stream of tasks
executed using <tt>local</tt> mean, and (by default) both the standard error
and standard output streams of tasks executed using <tt>ssh</tt> mean.

<p>This feature enable centralizing tasks error streams in qron log. However
not all task logs should be recorded that way. For instance if a 4 hours-long
huge Java batch logging millions of debug lines send them to its stderr,
qron logs will be no longer readable since they will be filled with crap.
One should take care of that when designing batches, or their wrapper shell
script.
Or logging can be disabled for a given task or taskgroup using parmeters
described below.

<p>Loging of tasks output is modified by several
<a href="#special-parameters">special task parameters</a>:
<ul>
<li><tt><a href="#param-stderrfilter">stderrfilter</a></tt>: regular
expression to filter out task output, for instance:
  <ul>
  <li><tt>.*</tt> will drop any data
  <li><tt>^Connection to [^ ]* closed.$</tt> will drop an ennoying ssh
  log line
  </ul>
<li><tt><a href="#param-ssh.disablepty">ssh.disablepty</a></tt>: when
disabling pty allocation of a task
executed through <tt>ssh</tt> mean, standard output will no longer be
merged with standard error and only the later will be recorded in qron
log (this is not the only effect of disabling pty allocation, see
<a href="#param-ssh.disablepty">special parameters</a> section for more
information
<li><tt><a href="#param-ssh.options">ssh.options</a></tt>: this more
general parameter can also, among other things, disable pty allocation
</ul>

<h3>Logs Format</h3>

<p>Qron log files are formatted with lines ended with the newline character
(<tt>0x0a</tt>), each line complying to either of these two formats:
<ul>
<li>First record lines immediatly start with a timestamp (in other words,
their first character is a digit, likely to be a <tt>2</tt>):
<pre>timestamp taskid/taskinstanceid sourcefile:sourceline severity message</pre>
<li>Continuation lines start with two spaces (<tt>0x20</tt>):
<pre>  message_continuation</pre>
</ul>

<p>Log records fields are defined this way:
<ul>
<li><tt>timestamp</tt>: <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO
8601</a> timestamp, currently from year to milliseconds, with or without
timezone (currently the timestamp is recorded using local timezone but without
explicit timezone specification, this may change in the future)
<li><tt>taskid</tt>: either the taskid if the record is related to a specific
task, or the name of the logging thread (e.g. SchedulerThread or AlerterThread)
<li><tt>taskinstanceid</tt>: either the taskinstanceid if the record is
related to a specific task instance execution, or 0
<li><tt>sourcefile</tt>: source code file name if known/relevant, otherwise an
empty string
<li><tt>sourceline</tt>: source code line number or label if known/relevant,
otherwise an empty string
<li><tt>severity</tt>: record severity, currently among:
DEBUG INFO WARNING ERROR FATAL (this may change in the future but will stay an
alphanumeric identifier without spaces)
<li><tt>message</tt>: any text, encoded as UTF-8, if newlines are contained
in the message, it is continued on the next lines, with two extra space
characters (<tt>0x20</tt>) at the begining of the continuation lines
</ul>

For instance:
<pre>
2016-04-05T13:57:42,003 gridboard.failing/201604051357420004 : INFO starting task 'gridboard.failing' through mean 'local' after 1 ms in queue
2016-04-05T13:57:40,421 SchedulerThread/0 : INFO starting scheduler
</pre>

<h3>Logs Rotation</h3>

<p>Qron do not rotate, compress or purge its logfiles, however it reopens
them periodicaly (every minute) which make several log rotation patterns
easy to implement.
One of the following should be choosen, or even a mix of them.

<h4>Timestamped Logs File Names</h4>

<p>Defining log files with a timestamp in the name ensure that qron will
stop writing in a log 1 minute after the timestamp changes. Therefore old
log files can be compressed or archived by any external mean (e.g.
logrotate daemon or a task scheduled by qron itself) without need of
signaling qron to reopen its log files.

<p>Sample configuration file fragment:
<pre>
(log(level debug)(file "/var/log/qron/debug-%{=date:yyyyMMdd}.log"))
(log(level info)(file "/var/log/qron/info-%{=date:yyyyMMdd}.log"))
(taskgroup qron.tech)
(task logs-compress
  (taskgroup qron.tech)
  (mean local)
  (command 'find /var/log/qron -name "*.log" -mtime +1 -exec bzip2 {} \\;')
  (trigger(cron 0 2 0 * * *))
)
(task logs-purge
  (taskgroup qron.tech)
  (mean local)
  (command 'find /var/log/qron -mtime +365 -delete')
  (trigger(cron 0 2 0 * * *))
)
</pre>

<h4>Numbered Log Files Names</h4>

<p>When scheduling a small amount of tasks, on can prefer to have a
numbered log files scheme. The example below show it with a
weekly rotation and compression processed by logrotate.

<p>Sample configuration file fragment:
<pre>
(log(level info)(file /var/log/qron.log))
</pre>

<p>Along with a logrotate configuration file like this one:
<pre>
/var/log/qron.log {
    weekly
    rotate 52
    missingok
    notifempty
    compress
    delaycompress
}
</pre>

<h2>Alerts</h2>

<p>There are two kinds of alerts:
<ul>
<li><tt>stateful</tt> alerts, which are <tt>emitted</tt> when <tt>raised</tt>
and <tt>canceled</tt> but also periodically <tt>reminded</tt> if still raised
<li><tt>one-shot</tt> alerts which are <tt>emitted</tt> immediatly each time
they occur: they are de-duplicated to avoid spam but are not subject to
raise/cancel/remind mechanisms.
</ul>

<p>Whenever possible, <tt>stateful</tt> alerts should be prefered, however
there are cases where one wants to be alerted of the occurrence of a abnormal
or rare event rather than of an abnormal condition. In these cases
<tt>one-shot</tt> alerts are well suited.

<p>Both alerts kind are UTF-8 characters strings, there are no technical
constraints on their format, however the
<a href="#alerts-subscriptions">subscriptions</a>
mechanisms will be easier to use if the alert strings follow a hierarchical
dot naming convention, e.g. <tt>task.failure.$TASKGROUP.$TASK</tt> or
<tt>myapp.mycustomalert</tt>.

<p>Alerts are notified through <a href="#alert-channels">alert channels</a>
and can be displayed on <a href="#wui">web ui</a>, especially using
<a href="#gridboards">gridboards</a>.

<h3>Stateful Alerts</h3>

<p>At first glance, stateful alerts have 3 statuses: <tt>nonexistent</tt>,
<tt>raised</tt> and <tt>canceled</tt>.
However, if an alert is constantly raised and canceled,
without protection it would be a huge source of spam/noise and there would be
no benefit to handle alerts as stateful. Therefore the alert engine implements
grace delays before actually raising or canceling an alert, and there are a few
more statuses and transitions than the most intuitive ones. They are described
below.

<p>Alerts State Diagram:
<img class="img-responsive center-block"
src="img/alerts_statuses.svg"
title="Alerts State Diagram" />

<p>Alerts statuses:
<ul>
<li><tt>nonexistent</tt>: the alert string is not known to the alert engine
<li><tt>rising</tt>: the alert has been asked for rising since less than the
<tt>rise delay</tt>
<li><tt>mayrise</tt>: the alert has been asked for cancellation while it was
rising, and <tt>mayrise delay</tt> has not yet been reached
<li><tt>raised</tt>: the alert was rising and rising delay has been reached, or
the alert has been asked for immediate rising
<li><tt>dropping</tt>: the alert has been asked for cancellation while it was raised, and <tt>drop delay</tt> has not yet been reached
<li><tt>canceled</tt>: the alert was dropping and drop delay has been reached,
or the alert has been asked for immediate cancellation
</ul>

<p>Alerts status transitions:
<ul>
<li><tt>raiseAlert()</tt>: turn a <tt>dropping</tt> alert into <tt>raised</tt>
and any other alert into <tt>rising</tt>
<li><tt>cancelAlert()</tt>: turn a <tt>rising</tt> alert into <tt>mayrise</tt>
and a <tt>raised</tt> alert into <tt>dropping</tt>
<li><tt>raiseImmediatlyAlert()</tt>: turn any alert into <tt>raised</tt>
<li><tt>cancelImmediatlyAlert()</tt>: turn <tt>rising</tt> and <tt>mayrise</tt>
alerts into <tt>nonexistent</tt>, and turn <tt>raised</tt> and <tt>dropping</tt>
alerts into <tt>canceled</tt>
<li><tt>rise delay</tt> timeout: turn <tt>rising</tt> and <tt>mayrise</tt>
alerts into <tt>raised</tt>
<li><tt>mayrise delay</tt> timeout: turn <tt>mayrise</tt> alerts into
<tt>nonexistent</tt>
<li><tt>drop delay</tt> timeout: turn <tt>dropping</tt> alerts into
<tt>canceled</tt>
<li><tt>canceled</tt> alerts will immediatly become <tt>nonexistent</tt> again,
as soon as cancel notifications are emitted
</ul>

<p>Induced effects:
<ul>
<li>When an alert becomes <tt>raised</tt> and was neither <tt>raised</tt> nor
<tt>dropping</tt> before, an alert is <tt>emitted</tt> for all matching
<a href="#alerts-subscriptions"><tt>subscriptions</tt></a>.
<li>When an alert becomes <tt>canceled</tt>, an alert cancellation is
emitted for all matching subscriptions.
<li>When an alert stays <tt>raised</tt> or <tt>dropping</tt> for a long time,
some <a href="#alert-channels">alert channels</a> (most notabily the mail
channel) will notify subscribers with alert <tt>reminders</tt>.
</ul>

<p>See <a href="#alerts-fine-tuning">alerts fine tuning</a> section below
for delays default values and advices on their tuning when needed.

<h3>One-Shot Alerts</h3>

<p>One-shot alerts have no state. They are (almost) immediately emitted each
time they are required to.

<p>To avoid noise/spam, only the first emission request during
<tt>duplicate emit delay</tt> interval triggers an immediate alert emission,
the following ones are counted and only one other alert will be actually
emitted after the delay expires.

<p>The emission counter is displayed by
<a href="#alert-channels">alert channels</a> in a appropriate way, by default
they will suffix the alert string with an <tt>x</tt> and the counter value,
e.g.: <tt>scheduler.config.load x 3</tt>.

<p>See <a href="#alerts-fine-tuning">alerts fine tuning</a> section below
for delays default values and advices on their tuning when needed.

<h3>Alert Channels</h3>

<h3 id="alerts-subscriptions">Subscriptions</h3>

<h3>Automatic Alerts</h3>

<h3>Custom Alerts</h3>

TODO: custom alerts through events and actions, but also from outside qron using the <a href="#http-api">HTTP API</a>

<h3>Gridboards</h3>

<p>Provided they follow a name convention that can be expressed using regular
expression capture groups, some alerts can be arranged as tables of statuses
named gridboards.

<p>A gridboard is described by its id and several properties among the
following:
<ul>
<li><tt>pattern</tt>: alert pattern to be processed by this gridboard, must be
a <a href="https://en.wikipedia.org/wiki/Regular_expression">regular expression
with named capture groups</a>, e.g.
<tt>^task\.(?&lt;status&gt;[^\.]+)\.(?&lt;taskid&gt;.+)$</tt>
<li><tt>dimension</tt>: declare a dimension, first one being displayed as rows,
second one as columns, using one of the following syntaxes:
  <ul>
  <li>just the capture group name declared in the pattern, e.g.
  <tt>(dimension taskid)</tt>
  <li>a dimension name and a <a href="#percent-evaluation">%-expression</a>,
  e.g. <tt>(dimension TaskId %taskid)</tt> (note that the regular expression
  capture groups are visible in the %-evaluation context which make it possible
  to use a capture group name or number as a % key)
  <li>the second dimension is not mandatory, if omitted, the gridboard will be
  built as if there was a second dimension declared with
  <tt>(dimension status status)</tt>, i.e. only one column, named "status".
  </ul>
<li><tt>label</tt>
<li><tt>info</tt>
<li><tt>warningdelay</tt> default 0
<li><tt>param</tt> gridboard parameters, used in
  <a href="#percent-evaluation">%-evaluation</a> performed within the context
  of this gridboard; in addition some parameters can be used to customize
  HTML rendering of the gridboard:
  <ul>
  <li><tt>gridboard.tableclass</tt>: HTML table class, defaults to
  <tt>table table-condensed table-hover</tt>
  <li><tt>gridboard.divclass</tt>: HTML div class for whole gridbard, defaults
  to <tt>row gridboard-status</tt>
  <li><tt>gridboard.componentclass</tt>: HTML div class for each gridboard
  component, defaults to <tt>gridboard-component</tt>
  <li><tt>gridboard.tdclass.ok</tt>: HTML table cell class for canceled alerts,
  defaults to an empty string
  <li><tt>gridboard.tdclass.warning</tt>: HTML table cell class for canceled
  alerts not canceled for longer than the <tt>warningdelay</tt>, defaults to
  <tt>warning</tt>
  <li><tt>gridboard.tdclass.error</tt>: HTML table cell class for raised
  alerts, defaults to  <tt>danger</tt>
  <li><tt>gridboard.tdclass.unknown</tt>: HTML table cell class in unknown
  status (most likely never raised nor canceled), defaults to an empty string
  <li><tt>gridboard.rowformat</tt>: custom format for row headers (i.e. first
  dimension values), this is a <a href="#percent-evaluation">%-expression</a>
  where <tt>%1</tt> is replaced with the actual dimension value, defaults to
  <tt>%1</tt>, example below
  <li><tt>gridboard.columnformat</tt>: same as <tt>gridboard.rowformat</tt>
  for the second dimension
  </ul>
</ul>

<p>For instance it is possible to set up a gridboard relying on
<a href="#automatic-alerts">automatic alerts</a> to display one task per
row and several columns and, for each task, if it has failed recently,
if it has been too long or too short recently, etc. using this configuration:

<pre>
(gridboard tasks
  (label Tasks Alerts)
  # match qron's automatic alerts about tasks: failure, toolong, tooshort...
  (pattern "^task\.(?&lt;status&gt;[^\.]+)\.(?&lt;taskid&gt;.+)$")
  (dimension taskid)
  (dimension status)
  # add an HTML link to the task page to the taskid in row headers
  (param gridboard.rowformat
    '&lt;a href="taskdoc.html?taskid=%1"&gt;%1&lt;/a&gt;')
)
</pre>

<p>An example of the HTML rendering of this gridboard would be:
<img class="img-responsive center-block"
src="img/gridboards-tasks-sample.png"
title="Rendering sample of 'Tasks Alerts' gridboard" />

<p>Apart from setting up a gridboard to display default automatic alerts
raised by qron, it is also possible to use this feature with some
<a href="#custom-alerts">custom alerts</a>, being them raised using the
<a href="#actions">alert-related actions</a> or from any external source
using the <a href="#http-api">HTTP API</a>.

<p>Here are some examples of dashboards associated to host and application
servers supervision probes:

<pre>
(gridboard ping
  (label Hosts Ping Statuses)
  # match alerts of the form host.down.ping.$HOST
  (pattern "^host\.down\.ping\.(?<host>[^\.]+)")
  # first and only dimension is the host
  (dimension host)
  # implicitely there is a second dimension, always equal to "status"
  (warningdelay 120) # shown as warning after 2 minutes w/o ping status
)
</pre>

<p>An example of the HTML rendering of this gridboard would be:
<img class="img-responsive center-block"
src="img/gridboards-tasks-sample.png"
title="Rendering sample of 'Hosts Ping Statuses' gridboard" />

<pre>
(gridboard service_x_instance
  (label Application Services x Deployed Instances)
  # match alerts of the form host.down.http.$HOST.$PORT.$PATH
  (pattern "^host\.down\.http\.(?<host>[^\.]+)\.(?<port>[0-9]+)\.(?<path>.+)$")
  # first dimension is the service, identified by its http path
  (dimension service %path))
  # second dimension is the instance, identified by %host:%port, with special
  # processing on %host to remove everything after first dash
  (dimension instance %{=sub:%host:/-.*//}:%port)
  (warningdelay 300) # shown as warning after 2 minutes w/o http status
)
</pre>

<p>An example of the HTML rendering of this gridboard would be:
<img class="img-responsive center-block"
src="img/gridboards-service_x_instance-sample.png"
title="Rendering sample of 'Application Services x Deployed Instances' gridboard" />

<h3 id="alerts-fine-tuning">Fine Tuning</h3>

TODO

<h2>Events and Actions</h2>

<p>Some events can be subscribed at <a href="#task-level-events">task level</a>
or <a href="#scheduler-level-events">scheduler level</a> to make the scheduler
perform one or several <a href="#actions">actions</a>. Events and actions are
described below.

<h3>Task-Level Events</h3>

<p>At task (and taskgroup) level, the following events can be subscribed:
<ul>
<li><tt>onstart</tt>: occurs just before a task begin to run
<li><tt>onsuccess</tt>: occurs just after a task finished with a successful
status
<li><tt>onfailure</tt>: occurs just after a task finished with a failure
status
<li><tt>onfinish</tt>: short for <tt>onsuccess</tt> and <tt>onfailure</tt>
</ul>

<p>Sample configuration file fragment:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (onsuccess
    # sending UDP packets to statsd server, see https://github.com/etsy/statsd
    (requesturl "task.%!taskid.ok:1|c" (address udp://127.0.0.1:8125))
    (requesturl (address udp://127.0.0.1:8125) "task.%!taskid.time:%!totalms|ms")
    # add a custom debug log for task success
    (log(severity debug) task success! *%!tasklocalid*)
  )
  (onfailure
    # sending UDP packets to statsd
    (requesturl(address udp://127.0.0.1:8125) "task.%!taskid.ko:1|c")
  )
)
</pre>

<h3>Scheduler-Level Events</h3>

<p>At scheduler (global) level, the following events can be subscribed:
<ul>
<li><tt>onschedulerstart</tt>: occurs when qron daemon starts
<li><tt>onconfigload</tt>: occurs whenever qron daemon activate a new
configuration, including at startup
<li><tt>onnotice</tt>: occurs whenever a <a href="#notices">notice</a> is
posted
<li><tt>onlog</tt>: occurs whenever a log entry is recorded, this event is
obviously only available for debuging purposes, using it on real-world
live systems is not advisable
<li>every <a href="#task-level-events">task-level events</a> can also be
subscribed at scheduler level, they will be applicable to every task
</ul>

<p>Sample configuration file fragment:
<pre>
(config
  # emit an alert to warn of a configuration (re)load
  (onconfigload (emitalert config.reload))
  # send UDP packets to statsd server on every task success or failure,
  # see https://github.com/etsy/statsd
  (onsuccess
    (requesturl "task.%!taskid.ok:1|c" (address udp://127.0.0.1:8125))
    (requesturl (address udp://127.0.0.1:8125) "task.%!taskid.time:%!totalms|ms")
  )
  (onfailure
    (requesturl(address udp://127.0.0.1:8125) "task.%!taskid.ko:1|c")
  )
)
</pre>

<h3>Actions</h3>

<p>Here are the actions that can be performed when an <tt>event</tt> occurs:
<ul>
<li><tt>postnotice</tt>: post a <a href="#notices">notice</a>
<li><tt>raisealert</tt>: raise a <a href="#raisable-alerts">raisable alert</a>
<li><tt>cancelalert</tt>: cancel a raisable alert
<li><tt>emitalert</tt>: emit an <a href="#emitted-alerts">emitted alert</a>
<li><tt>requesttask</tt>: request task execution
<li><tt>requesturl</tt>: request a network action by url, currently only UDP
and HTTP are supported
<li><tt>log</tt>: add an entry to <a href="#logs">centralized log</a>
<li><tt>step</tt>: activate another step, only available within a
<a href="#workflows-and-subtasks">workflow task</a>
<li><tt>end</tt>: ends the workflow, only available within a workflow task
</ul>

<p>Sample configuration file fragments:
<pre>
TODO
</pre>
<pre>
TODO
</pre>
<pre>
TODO
</pre>

<h3>Notices</h3>

<p>

<h2>Resources</h2>

<h2>Parameters</h2>

<h3>Hierarchical Inheritance of Parameters Sets</h3>

<p>TODO

<p>Parameters Sets Hierarchy:
<img class="img-responsive center-block"
src="img/paramset_hierarchy.svg"
title="Parameters Sets Hierarchy" />

<div class="row">
  <div class="col-md-6">
  </div>
  <div class="col-md-6">
    <p>Caption:
    <img class="img-responsive center-block"
      src="img/paramset_hierarchy_caption.svg"
      title="Parameters Sets Hierarchy Caption" />
    <!-- LATER: ensure same scaling than main diagram, via JS, rather than
      arbitrary set width to 50% -->
  </div>
</div>

<h3 id="percent-evaluation">%-Evaluation</h3>

<h3>Special Parameters</h3>

<h2>Configuration Management</h2>

TODO

<h2>Operations</h2>

<h3>Task Instances Lifecycle</h3>

<h4>Task Instances Statuses</h4>

<p>Task Instances State Diagram:
<img class="img-responsive center-block"
src="img/taskinstances_statuses.svg"
title="Task Instances State Diagram" />

<p>Task instances statuses:
<ul>
<li><tt>queued</tt>: task execution has been requested and queued but is not
yet starting, likely because some
<a href="#tasks-triggers-and-constraints">constraints</a> still disable the
task to run (not enough <a href="#resources">resources</a> available,
<tt>maxinstances</tt> already reached by currently running instances, etc.)
<li><tt>running</tt>: task instance has been started and is not yet ended
<li><tt>success</tt>: task instance has been ended and
<a href="#task-instances-success-conditions">success conditions</a> was met
<li><tt>failure</tt>: task instance has been ended and
<a href="#task-instances-success-conditions">success conditions</a> was not
met
<li><tt>canceled</tt>: task request was canceled before started
</ul>

<p>Task instances transitions:
<ul>
<li><tt>requestTask()</tt>: explicit task request from API or UI
<li>request by configuration (trigger, action, workflow transition, etc.):
implicit task request deduced from configuration
<li>start: when <a href="#tasks-triggers-and-constraints">constraints</a> are
met, a queued task is started and reaches <tt>running</tt> status
<li>end: when the underlying process finishes, the task instance is set to
either <tt>success</tt> or <tt>failure</tt> status depending on
<a href="#task-instances-success-conditions">success conditions</a>
<li><tt>cancelTask()</tt>: a <tt>queued</tt> task instance can be canceled
from API or UI, and then reaches <tt>canceled</tt> status, a <tt>running</tt>
task can no longer be canceled
<li>implicit cancellation: task instances can be implicitely canceled when
several requests are enqueued for the same task, depending on
<a href="#enqueuepolicy">enqueuepolicy</a>
<li><tt>abortTask()</tt>: a <tt>running</tt> task instance can be aborted
from API or UI, triggering the end of the underlying process, depending on
<a href="#tasks-execution-properties">execution mean</a> (sending kill
signal for <tt>local</tt> execution mean, closing socket for <tt>http</tt>
execution mean, etc.), leading to a fast end of the task in conditions that
are interpreted as a <tt>failure</tt> by default;
<br/>not all task instances can be aborted (for instance a <tt>ssh</tt> task
cannot be aborted if pty allocation is explicitly disabled), but most of them
can;
<br/>it is possible to define custom
<a href="#task-instances-success-conditions">success conditions</a>
in a way that make an aborted task be interpreted as a <tt>success</tt>, but
default success conditions will always interpret an abort as a failure
<li>failure on start with some configuration errors: when configuration errors
are detected in the start process and before the actual task is started,
a task instance status can be set from <tt>queued</tt> to <tt>failure</tt>
without even reaching <tt>running</tt>, for instance if the <tt>target</tt> is
not set or is invalid and the execution mean requires a target
</ul>

<h4>Task Instances Timestamps and Durations</h4>

A task instance bears several timestamps, set when it reaches different
steps of its lifecycle.
Any of them can be null since the corresponding step may not have been
reached.
<ul>
<li><tt>requestdate</tt>: set when the task is created (and immediatly reaches
<tt>queued</tt> status)
<li><tt>startdate</tt>: set when the task reaches <tt>running</tt> status,
which may never happen if the task never starts (if canceled or if an error
occurs during start process)
<li><tt>enddate</tt>: set when the task reaches <tt>success</tt>,
<tt>failure</tt> or <tt>canceled</tt> status; it should always happen at some
time but can be long, and may even never happen in some abnormal cases (server
crash, etc.)
</ul>

Those timestamps can be read from API, UI and used in configuration through
<a href="#percent-evaluation">%-expressions</a>, e.g.:
<pre>
  %!startdate # this task instance start date
  %{!enddate:yyyy-MM-dd} # end date with format specification
  %!workflowrequestdate # main task instance (if subtask) request date
  %{!workflowrequestdate:yyyyMMdd:-1days} # eve of main task request date
  %{!statdate:ms1970} # this (sub)task start date in milliseconds since 1970
</pre>

For instance this can be used to set a task param or setenv according to
the request or start timestamp (but obviously not the end timestamp):
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (trigger(cron 0 0 23 * * 1-6))
  (param filename /tmp/%{!workflowstartdate:yyyyMMdd}.out)
  (mean local)
  (command /opt/myapp/bin/build-reports-customers.sh -o %filename)
)
(task build-reports-customers-alternative
  (taskgroup app1.biz.batch)
  (trigger(cron 0 0 23 * * 1-6))
  (setenv FILENAME /tmp/%{!workflowstartdate:yyyyMMdd}.out)
  (mean local)
  (command /opt/myapp/bin/build-reports-customers.sh) # the script uses $FILENAME
)
</pre>

Several durations are computed from these timestamps.
Any of them is null if its start or end timestamp is null.
<ul>
<li><tt>queued</tt>: <tt>startdate - requestdate</tt>
<li><tt>running</tt>: <tt>enddate - startdate</tt>
<li><tt>total</tt>: <tt>enddate - requestdate</tt>
</ul>

<a href="#tasks-monitoring">Task monitoring features</a>, always use the worst
case duration to trigger alerts, e.g. <tt>total</tt> duration for
<tt>maxexpectedduration</tt> and <tt>running</tt> duration for
<tt>minexpectedduration</tt>.

Like timestamps, durations can also be read from API, UI and used in
configuration through <a href="#percent-evaluation">%-expressions</a>, e.g.:
<pre>
  %!totalms # total duration, in milliseconds
  %!queueds # time spent in queue, in seconds
</pre>

For instance this can be used to feed reporting or monitoring systems with
metrics about tasks durations:
<pre>
(onsuccess
  # sending UDP packets to statsd server, see https://github.com/etsy/statsd
  (requesturl (address udp://127.0.0.1:8125) "task.%!taskid.time:%!totalms|ms")
  (requesturl (address udp://127.0.0.1:8125) "task.%!taskid.delay:%!queuedms|ms")
)
</pre>

<h4>Task Instances Success Conditions</h4>

<h3>Actions Performed by an Operator</h3>

<h4>Reloading Configuration</h4>

<h4>Requesting a Task Execution</h4>

<h4>Canceling a Task Request</h4>

<h4>Aborting a Task Execution</h4>

<h4>Disabling a Task</h4>

<h2 id="wui">Web User Interface</h2>

<h3 id="#wui-description">Description</h3>

<p> TODO incl. responsive-design and bootstrap-based

<h3 id="#wui-views">Views</h3>

<p> TODO concept and description of every view

<h3 id="#wui-customization">Customization</h3>

<p> TODO through parameters

<h2 id="http-api">HTTP API (REST API)</h2>

Qron's HTTP API is splitted into a REST API (paths begining with /rest/) and a
RPC API (paths begining with /do/) which is as simple
as a REST API but action-oriented rather than data-oriented and does not rely
on HTTP methods to determine the action as the REST API does.

<p>Whatever HTTP URI whose path is not begining with /do/ or /rest/ is not
part of the HTTP API, it's only UI. Backward compatibility of UI URIs can
be broken between Qron's versions without notice (they should only be linked
from within Qron web UI itself, not called or referenced by any third party
tool).

<h3>REST API</h3>

<p>REST calls are described in the table below. They complies with the
following rules:
<ul>
<li>HTTP method widespread REST semantics: <tt>GET</tt> is read-only and has
no side effect, <tt>POST</tt> means create, <tt>PUT</tt> means update
<li>response content-type is defined in the request path (e.g. ending with
.html to ask for HTML) not in content-type HTTP headers, to have a more
natural explicit choice and avoid any kind of out-of-band parameters
<li>paths always start with <tt>/rest/%version/%collection_name/</tt>, most
of them are followed by a collection-wide view (e.g. <tt>list.csv</tt>) or
the object id within the collection (e.g. <tt>2783794.html</tt>).
<li>reply HTTP statuses can be trusted with their standard meaning, at less
for the first digit (2xx: success, 4xx: input error, 5xx: server-side error,
401 and 403 used for authentication)
</ul>

<p>The following table describes REST calls:
<p><table class="table table-condensed table-hover table-striped">
<tr><th>Call</th><th>Description</th></tr>
<tr><td><tt>
<p>GET /rest/v1/taskgroups/list.csv
<p>GET /rest/v1/taskgroups/list.html
</tt>
</td><td>list of task groups</td></tr>
<tr><td><tt>
<p>GET /rest/v1/tasks/%taskid/config.pf
</tt>
</td><td>task %taskid's configuration, in config file format</td></tr>
<tr><td><tt>
<p>GET /rest/v1/tasks/%taskid/workflow.svg
<p>GET /rest/v1/tasks/%taskid/workflow.dot
</tt>
</td><td>task %taskid's workflow diagram, in SVG or Graphviz dot format</td></tr>
<tr><td><tt>
<p>GET /rest/v1/tasks/list.csv
<p>GET /rest/v1/tasks/list.html
</td><td>list of tasks</td></tr>
<tr><td><tt>
<p>GET /rest/v1/tasks/deployment_diagram.svg
<p>GET /rest/v1/tasks/deployment_diagram.dot
</td><td>deployment diagram (taskgroup to tasks to either cluster or host
graph), in SVG or Graphviz dot format</td></tr>
<tr><td><tt>
<p>GET /rest/v1/tasks/trigger_diagram.svg
<p>GET /rest/v1/tasks/trigger_diagram.dot
</td><td>trigger diagram (taskgroup to tasks to trigger graph), in SVG or
Graphviz dot format</td></tr>
<tr><td><tt>
<p>GET /rest/v1/steps/list.csv
<p>GET /rest/v1/steps/list.html
</tt>
</td><td>list of workflow tasks steps</td></tr>
<tr><td><tt>
<p>GET /rest/v1/hosts/list.csv
<p>GET /rest/v1/hosts/list.html
</tt>
</td><td>list of hosts</td></tr>
<tr><td><tt>
<p>GET /rest/v1/clusters/list.csv
<p>GET /rest/v1/clusters/list.html
</tt>
</td><td>list of clusters</td></tr>
<tr><td><tt>
<p>GET /rest/v1/global_params/list.csv
<p>GET /rest/v1/global_params/list.html
</tt>
</td><td>list of global params</td></tr>
<tr><td><tt>
<p>GET /rest/v1/global_setenvs/list.csv
<p>GET /rest/v1/global_setenvs/list.html
</tt>
</td><td>list of global setenvs</td></tr>
<tr><td><tt>
<p>GET /rest/v1/global_unsetenvs/list.csv
<p>GET /rest/v1/global_unsetenvs/list.html
</tt>
</td><td>list of global unsetenvs</td></tr>
<tr><td><tt>
<p>GET /rest/v1/calendars/list.csv
<p>GET /rest/v1/calendars/list.html
</tt>
</td><td>list of named calendars</td></tr>
<tr><td><tt>
<p>GET /rest/v1/taskinstances/list.csv
<p>GET /rest/v1/taskinstances/list.html
<p>GET /rest/v1/taskinstances/list.csv?status=%list
<p>GET /rest/v1/taskinstances/list.html?status=%list
</tt>
</td><td>list of task instances, if status parameter is set, the followed
values are supported as %list:
<ul>
<li><tt>queued</tt>
<li><tt>running</tt>
<li><tt>queued,running</tt>
</ul>
</td></tr>
<tr><td><tt>
<p>GET /rest/v1/scheduler_events/list.csv
<p>GET /rest/v1/scheduler_events/list.html
</tt>
</td><td>list of scheduler events subscriptions</td></tr>
<tr><td><tt>
<p>GET /rest/v1/notices/lastposted.csv
<p>GET /rest/v1/notices/lastposted.html
</tt>
</td><td>list of last posted notices, in reverse chronological order</td></tr>
<tr><td><tt>
<p>GET /rest/v1/resources/free_resources_by_host.csv
<p>GET /rest/v1/resources/free_resources_by_host.html
</tt>
</td><td>free resources x host matrix</td></tr>
<tr><td><tt>
<p>GET /rest/v1/resources/lwm_resources_by_host.csv
<p>GET /rest/v1/resources/lwm_resources_by_host.html
</tt>
</td><td>low water mark resources x host matrix</td></tr>
<tr><td><tt>
<p>GET /rest/v1/resources/consumption_matrix.csv
<p>GET /rest/v1/resources/consumption_matrix.html
</tt>
</td><td>task × host × theorical lowest possible resources availability matrix</td></tr>
<tr><td><tt>
<p>GET /rest/v1/alert_params/list.csv
<p>GET /rest/v1/alert_params/list.html
</tt>
</td><td>list of alert params</td></tr>
<tr><td><tt>
<p>GET /rest/v1/alerts/stateful_list.csv
<p>GET /rest/v1/alerts/stateful_list.html
</tt>
</td><td>list of current stateful alerts, with their state and timestamps</td></tr>
<tr><td><tt>
<p>GET /rest/v1/alerts/last_emitted.csv
<p>GET /rest/v1/alerts/last_emitted.html
</tt>
</td><td>list of recently emitted alerts, last one first</td></tr>
<tr><td><tt>
<p>GET /rest/v1/alerts_subscriptions/list.csv
<p>GET /rest/v1/alerts_subscriptions/list.html
</tt>
</td><td>list of alerts subscriptions</td></tr>
<tr><td><tt>
<p>GET /rest/v1/alerts_settings/list.csv
<p>GET /rest/v1/alerts_settings/list.html
</tt>
</td><td>list of alerts settings</td></tr>
<tr><td><tt>
<p>GET /rest/v1/gridboards/list.csv
<p>GET /rest/v1/gridboards/list.html
</tt>
</td><td>list of gridboards</td></tr>
<tr><td><tt>
<p>GET /rest/v1/gridboards/%1.html
</tt>
</td><td>gridboard %1, rendered as one or several html tables</td></tr>
<tr><td><tt>
<p>GET /rest/v1/configs/list.csv
<p>GET /rest/v1/configs/list.html
</tt>
</td><td>list of loaded configurations</td></tr>
<tr><td><tt>
<p>GET /rest/v1/configs/history.csv
<p>GET /rest/v1/configs/history.html
</tt>
</td><td>list of active configurations history, current one first</td></tr>
<tr><td><tt>
<p>GET /rest/v1/configs/%1.pf
</tt>
</td><td>config %1, in config file format</td></tr>
<tr><td><tt>
<p>POST /rest/v1/configs/
</tt>
</td><td>upload a config, in config file format; uploaded config is not
activated, it is only loaded (see /do/v1/configs/activate/)
<p>reply body will be of the form <tt>(id %1)</tt>, %1 being replaced by
uploaded config id
<p>reply has <tt>X-Qron-ConfigId</tt> http header set to uploaded config id,
for clients that would find easier to read headers than body</td></tr>
<tr><td><tt>
<p>GET /rest/v1/logs/logfiles.csv
<p>GET /rest/v1/logs/logfiles.html
</tt>
</td><td>list of logfiles</td></tr>
<tr><td><tt>
<p>GET /rest/v1/logs/entries.txt
</tt>
</td><td>last log entries, last one last
<p>optional parameters:
<ul>
<li><tt>files</tt>: if set to <tt>current</tt> only fetch current log files
entries, ignoring older files (useful with e.g. daily-rotated log files)
<li><tt>filter</tt>: plain text filter string
<li><tt>regexp</tt>: regular expression filter
</ul> </td></tr>
<tr><td><tt>
<p>GET /rest/v1/logs/last_info_entries.csv
<p>GET /rest/v1/logs/last_info_entries.html
</tt>
</td><td>last log entries with at less INFO severity level, in csv or html
table format, last one last</td></tr>
</table>

<h3>RPC API</h3>

<p>RPC calls are described in the table below. They complies with the
following rules:
<ul>
<li>calls are handled with the same meaning regardless which HTTP method
is used (GET or POST), the meaning is given by the path
<li>paths always start with <tt>/do/%version/%domain/%action/</tt>, and in
most cases the domain is a collection_name (e.g. tasks).
<li>for calls using HTTP params, both URI request string params (GET) and
body x-www-form-urlencoded  params (POST) are supported, behavior when using
both at a time is unspecified (so don't mix them, this may work in a given
qron version and not in the next one, or not with the same priority/overriding
implicit rules)
<li>reply HTTP statuses can be trusted with their standard meaning, at less
for the first digit (2xx: success, 4xx: input error, 5xx: server-side error,
401 and 403 used for authentication)
</ul>

<p>The following table describes RPC calls:
<p><table class="table table-condensed table-hover table-striped">
<tr><th>Call</th><th>Description</th></tr>
<tr><td><tt><p>POST|GET /do/v1/tasks/request/%taskid</tt>
</td><td>request execution of a task, HTTP params are used as task
instance overriding params</td></tr>
<tr><td><tt><p>POST|GET /do/v1/tasks/abort_instances/%taskid</tt>
</td><td>abort all running instances of a task</td></tr>
<tr><td><tt><p>POST|GET /do/v1/tasks/cancel_requests/%taskid</tt>
</td><td>cancel all queued requests of a task</td></tr>
<tr><td><tt><p>POST|GET /do/v1/tasks/cancel_requests_and_abort_instances/%taskid</tt>
</td><td>cancel all queued requests and abort all running instances of a
task</td></tr>
<tr><td><tt><p>POST|GET /do/v1/tasks/disable/%taskid</tt>
</td><td>disable a task from being queued and (if already queued) from
running</td></tr>
<tr><td><tt><p>POST|GET /do/v1/tasks/enable/%taskid</tt>
</td><td>(re-)enable a task</td></tr>
<tr><td><tt><p>POST|GET /do/v1/tasks/disable_all</tt>
</td><td>disable all tasks at once</td></tr>
<tr><td><tt><p>POST|GET /do/v1/tasks/enable_all</tt>
</td><td>enable all tasks at once</td></tr>
<tr><td><tt><p>POST|GET /do/v1/taskinstances/cancel/%taskinstanceid</tt>
</td><td>cancel a queued task instance (a.k.a. a task request)</td></tr>
<tr><td><tt><p>POST|GET /do/v1/taskinstances/cancel_or_abort/%taskinstanceid</tt>
</td><td>abort a running task instance</td></tr>
<tr><td><tt><p>POST|GET /do/v1/taskinstances/cancel_or_abort/%taskinstanceid</tt>
</td><td>cancel task instance if it's is still queued or abort it if it's
already running</td></tr>
<tr><td><tt><p>POST|GET /do/v1/alerts/emit/%alertid</tt>
</td><td>emit a one-shot alert</td></tr>
<tr><td><tt><p>POST|GET /do/v1/alerts/raise/%alertid</tt>
</td><td>raise a stateful alert</td></tr>
<tr><td><tt><p>POST|GET /do/v1/alerts/raise_immediately/%alertid</tt>
</td><td>raise immediately (without waiting for rise delay) a stateful
alert</td></tr>
<tr><td><tt><p>POST|GET /do/v1/alerts/cancel/%alertid</tt>
</td><td>cancel a stateful alert</td></tr>
<tr><td><tt><p>POST|GET /do/v1/alerts/cancel_immediately/%alertid</tt>
</td><td>cancel immediately (without waiting for cancel delay) a stateful
alert</td></tr>
<tr><td><tt><p>POST|GET /do/v1/notices/post/%notice</tt>
</td><td>post a notice, HTTP params are used as notice params</td></tr>
<tr><td><tt><p>POST|GET /do/v1/configs/reload_config_file</tt>
</td><td>reload configuration file and apply new configuration (if a
configuration file is defined, and its content is valid)</td></tr>
</table>

<h2>Appendices</h2>

<p>

</div>
      </div>
    </div>

<?include:common-scripts.html?>
<script>
anchors.add('.user-manual h2, .user-manual h3, .user-manual h4, .user-manual h5');
/*var paragraphAnchors = new AnchorJS({
  placement: 'left',
  icon: '¶'
});
paragraphAnchors.add('.user-manual p');*/
$('body').scrollspy({ target: '#navbar-manual' });
</script>
<?include:footer.html?>
