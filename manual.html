<!DOCTYPE html>
<!--
 Copyright 2016 Hallowyn and others.
 This file is part of qron, see <http://qron.eu/>.
 Qron is free software: you can redistribute it and/or modify
 it under the terms of the GNU Affero General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 Qron is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU Affero General Public License for more details.
 You should have received a copy of the GNU Affero General Public License
 along with qron. If not, see <http://www.gnu.org/licenses/>.
-->
<?include:header.html?>

      <div class="row">
        <div class="col-md-3">
          <nav class="hidden-print hidden-xs hidden-sm affix manual-sidebar" id="navbar-manual">
            <p><ul class="nav">
              <li><a href="#introduction">Introduction</a>
              <li><a href="#concepts">Concepts</a>
              <li><a href="#tasks-hierarchy">Tasks Hierarchy</a>
              <ul class="nav">
                <li><a href="#task-groups">Task Groups</a>
                <li><a href="#tasks">Tasks</a>
                <ul class="nav">
                  <li><a href="#tasks-description">Description</a>
                  <li><a href="#tasks-execution-properties">Execution Properties</a>
                  <li><a href="#tasks-triggers-and-constraints">Triggers and Constraints</a>
                  <li><a href="#tasks-parameters">Parameters</a>
                  <li><a href="#tasks-setenvs">Setenvs</a>
                  <li><a href="#tasks-events-subscriptions">Events Subscriptions</a>
                  <li><a href="#tasks-monitoring">Monitoring</a>
                  <li><a href="#tasks-request-forms">Request Forms</a>
                </ul>
                <li><a href="#workflows-and-subtasks">Wokflows and Subtasks</a>
              </ul>
              <li><a href="#infrastructure">Infrastructure</a>
              <ul class="nav">
                <li><a href="#hosts">Hosts</a>
                <li><a href="#clusters">Clusters</a>
              </ul>
              <li><a href="#logs">Logs</a>
              <li><a href="#alerts">Alerts</a>
              <ul class="nav">
                <li><a href="#raisable-alerts">Raisable Alerts</a>
                <li><a href="#emitted-alerts">Emitted Alerts</a>
                <li><a href="#alerts-subscriptions">Subscriptions</a>
                <li><a href="#automatic-alerts">Automatic Alerts</a>
                <li><a href="#gridboards">Gridboards</a>
                <li><a href="#alerts-fine-tuning">Fine Tuning</a>
                <li><a href="#custom-alerts">Custom Alerts</a>
              </ul>
              <li><a href="#events-and-actions">Events and Actions</a>
              <ul class="nav">
                <li><a href="#task-level-events">Task-Level Events</a>
                <li><a href="#scheduler-level-events">Scheduler-Level Events</a>
                <li><a href="#actions">Actions</a>
                <li><a href="#notices">Notices</a>
              </ul>
              <li><a href="#resources">Resources</a>
              <li><a href="#parameters">Parameters</a>
              <li><a href="#configuration-management">Configuration Management</a>
              <li><a href="#operations">Operations</a>
              <ul class="nav">
                <li><a href="#task-instances-statuses">Task Instances Statuses</a>
                <li><a href="#actions-performed-by-an-operator">Actions Performed by an Operator</a>
              </ul>
              <li><a href="#wui">Web User Interface</a>
              <ul class="nav">
                <li><a href="#wui-views">Views</a>
                <li><a href="#wui-customization">Customization</a>
              </ul>
              <li><a href="#appendices">Appendices</a>
              <ul class="nav">
                <li><a href="#configuration-file-format">Configuration File Format</a>
                <li><a href="#configuration-examples">Configuration Examples</a>
              </ul>
            </ul>
          </nav>
        </div>
        <div class="col-md-9 user-manual" data-spy="scroll" data-target="navbar-manual" data-offset="0">

<h1 id="introduction">Qron User Manual</h1>

<p>This page is <a href="http://qron.eu/">qron</a> user manual.

<p>It is available both in qron web user interface (embeded in qron daemon)
and on the Internet here:
<a href="http://qron.eu/manual/">http://qron.eu/manual/</a>.

<h2>Concepts</h2>

<p>Qron is a task scheduler, that is, a software controlling execution of
non-interactive application components such as large batches planned once a
day, automatic processing of incoming messages every minute, or any
processing triggered by an event not directly issued by a human being.

<p>This implies <a href="#hierarchy">defining tasks</a>, the way they are
<a href="#triggers">triggered</a>, the properties of the
<a href="#infrastructure">infrastructure</a> on which they run, alongside
with <a href="#alerts">alert means</a> to notify about anything wrong
or suspect.

<h2>Tasks Hierarchy</h2>

<p>Tasks are grouped within taskgroups in a tree hierarchy.
In addition, workflow tasks have subtasks.

<h3>Task Groups</h3>

<p>Tasks are grouped within taskgroups which make the configuration
more clear in a documentation point of view (when used to group tasks
e.g. by application or module) and/or by factorizing some task
properties (such as <a href="#parameters">paremeters</a> and
<a href="#events">events</a>).

<p>A taskgroup consist of its id (which is its only mandatory
field), plus optional fields: a human readable <tt>label</tt>
and task properties that are inherited by any task belonging
to the group. The task properties that can be defined at the
taskgroup level are <a href="#tasks-parameters"><tt>params</tt></a>,
<a href="#tasks-setenvs"><tt>setenv</tt> and <tt>unsetenv</tt></a>
and <a href="#tasks-events-and-actions">events subscriptions</a>.

<p>There is only one level of taskgroups (a taskgroup cannot
belong to another taskgroup) however dots in taskgroups id
are processed as a hierarchical separator by qron user interfaces
to display a multi-level tree.

<p>Sample configuration file fragments:
<pre>
(taskgroup app1.biz.batch
  (label business batches for application app1)
)
</pre>
<pre>
(taskgroup app2.tech
  (label technical tasks for application app2)
  (param db_password mysecret)
  (setenv ORACLE_SID ORCL)
)
</pre>
<pre>
(taskgroup minimalgroup)
</pre>

<h3>Tasks</h3>

<p>Task is qron's most important configuration element. It carries almost
every information needed to schedule and execute a task and often some of
the event and alerting configuration is done task by task.

<h4>Tasks Description</h4>

<p>A task is described by its id and its parent <tt>taskgroup</tt>.
It should also have a human readable <tt>label</tt> and some additional
documentation <tt>info</tt>.

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (label "build PDF reports about customers")
  (info "see http://intranet/app1/ReportingBatches")
)
</pre>
<pre>
(task oracle-statistics
  (taskgroup app2.tech)
  (label recompute statistics for db ORCL)
)
</pre>
<pre>
(task minimaltask(taskgroup minimalgroup))
</pre>

<h4>Tasks Execution Properties</h4>

<p>Task execution is defined by 3 properties:
<ul>
  <li><tt>mean</tt>: describes the mean used to execute the task, among the following:
  <ul>
    <li><tt>local</tt>: spawn a process local to the qron daemon, on the same
    host
    <li><tt>ssh</tt>: establish an SSH connection to the target host to
    execute the task
    <li><tt>http</tt>: perform an HTTP request
    <li><tt>workflow</tt>: start a workflow consisting of one or several
    subtasks conditionaly linked together with transitions, each of them having
    their own execution properties, see
    <a href="#workflows-and-subtasks">workflows</a> section below
    <li><tt>donothing</tt>: do not execute anything, but still trigger events,
    pretending the execution to be successful (i.e. <tt>onsuccess</tt> actions
    will be triggered, not <tt>onfailure</tt> ones)
  </ul>
  <li><tt>target</tt>: defines which <tt>host</tt> or <tt>cluster</tt> will be
    choosen to execute the task, defaults to <tt>localhost</tt>, see
    <a href="#infrastructure">infrastructure</a> section for more details
  <li><tt>command</tt>: interpreted depending on the execution mean:
  <ul>
    <li><tt>local</tt> and <tt>ssh</tt> means: command line, spaces being
    interpreted as command arguments separators but if they are protected
    by backslashes
    <li><tt>http</tt> mean: path and query string
    <li><tt>workflow</tt> and <tt>donothing</tt> means: not applicable, should
    be omitted
  </ul> 
</ul>

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (mean ssh)
  (target server1)
  (command /opt/app1/bin/build_reports.sh --customers)
)
</pre>
<pre>
(task process-last-orders
  (taskgroup app1.biz.queuing)
  (mean http)
  (target server4)
  (command /pollers/last-orders/?from=-5minutes)
  (param method POST) # defaults to GET
  (param user scheduler) # set up a "Authorization: Basic" header
  (param password mysecret)
)
</pre>

<h4>Tasks Triggers and Constraints</h4>

<p>Tasks are queued for execution when triggered, and one can defined one or
several triggers among:
<ul>
<li><tt>cron</tt>: time trigger in the form of Unix' cron pattern with precision
down to second, e.g.
  <ul>
  <li><tt>* * * * * *</tt>: every seconds
  <li><tt>13 6 7 * * 1</tt>: every monday (1) at 07:06:13 in the morning 
  <li><tt>/15 * 8-20 * * *</tt>: every 15 seconds from 8 a.m. to 8 p.m.
  </ul>
<li><tt>notice</tt>: event trigger that happen when a given
<a href="#notices">notice event</a> occurs
<li><tt>filechange</tt>: not yet implented, but will be able to trigger task
execution on local or remote file change or creation
<li>REST API: a task can be triggered by REST API
<a href="#requesttask-call"><tt>requesttask</tt> call</a>
<li><tt>requesttask</tt> event: a task can be triggered by occurrence of a
<a href="#events"><tt>requesttask</tt> event</a>
</ul>

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (trigger(cron 0 0 23 * * 1-6)) # 23:00 mon-sat
)
</pre>
<pre>
(task process-last-orders
  (taskgroup app1.biz.queuing)
  (trigger
    (cron /15 * 8-20 * * *) # every 15 seconds daily
    (cron 0 0 22 * * * # once in the evening
      (param mode nightly) # overriding parameter 'mode'
    )
    (notice process-last-orders-now) # on event
  )
)
</pre>

<p>However, when a task is queued for execution, it will be executed only when
no constraint disable the task from running. Contraints are of several types:
<ul>
<li><tt>maxinstances</tt>: a given task is only allowed to be run
<tt>maxinstances</tt> times at a time, which defaults to 1
<li><tt>resources</tt>: if a given task is declared to need some
<tt>resources</tt> it can only run on its target <tt>host</tt> if it has
enough resources available, resources can be seen as semaphores, and can be
used for mutual exclusion across tasks
</ul>

<p>Sample configuration file fragments:
<pre>
(task process-customer-request
  (taskgroup app1.biz.queuing)
  (maxinstances 16) # code is multiexec-safe and is faster when parallelized
)
</pre>
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (target report-server)
  (resource memory 2048) # avoid too many memory consummers on the server
  (resource reports-semaphore 1) # avoid two report batches running at a time
)
(host report-server
  (hostname server4.acme.com)
  (resource memory 8192)
  (resource reports-semaphore 1)
)
</pre>

<p>To avoid queued tasks to stack in big number, by default when a task is
queued, every other queued task with the same id is canceled.
This behavior can be disabled using <tt>discardaliasesonstart</tt> but most
of the time should not since it make it possible to fill the tasks queue.

<h4>Tasks Parameters</h4>

<p>Tasks have free text parameters defined by <tt>param</tt> configuration
element. They can be used for any custom parameters and are evaluated
with <tt>%</tt> evaluation character in many other configuration items.

<p>The whole system for parameters evaluation and inheritance is discussed in
deep in <a href="#parameters">parameters</a> section below alonside with
special parameters name that have an effect qron behavior (parameters such as
<tt>ssh.options</tt> when using ssh execution mean).

<p>Parameters can be overriden at task request, being it in trigger definition,
in REST API or in web user interface using
<a href="#tasks-request-forms">request forms</a>.

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (mean ssh)
  (target server1)
  (command /opt/app1/bin/build_reports.sh --customers --from %from)
  (param from -2days) # regular param value
  (trigger
    (cron 0 0 23 * * 1-6)
    (cron 0 0 23 * * 0 (param from -8days)) # different param on sunday
  )
  (requestform
    (field from # can be overriden when the task is started from the web ui
      (label Data depth) # ui label
      (placeholder -2days) # ui placeholder/hint
      (format "-[0-9]+days") # server side validation regexp
    )
  )
)
</pre>

<h4>Tasks Setenvs</h4>

<p>Depending on the execution <tt>mean</tt>, there can be out of band
parameters, transmitted by another way than the <tt>command</tt> itself.
For <tt>local</tt> and <tt>ssh</tt> means this is possible through
environment variables (hence the name <tt>setenv</tt>).
For <tt>http</tt> mean this is possible through custom HTTP headers.

<p>These out of band parameters are defined and removed using two configuration
elements: <tt>setenv</tt> and <tt>unsetenv</tt>.

<p>TODO: explain how default envionment is set, according to execution mean.

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (mean ssh)
  (target server1)
  (command /opt/app1/bin/build_reports.sh --customers)
  (setenv ORACLE_SID ORCL)
)
</pre>

<pre>
(task process-last-orders
  (taskgroup app1.biz.queuing)
  (mean http)
  (target server4)
  (command /pollers/last-orders/?from=-5minutes)
  (setenv X-TaskInstanceId %!taskinstanceid)
  (setenv Authorization Basic AhjsqduYez=)
  #in fact it's often easier to set Authorization header this way:
  #(param user scheduler) # set up a "Authorization: Basic" header
  #(param password mysecret)
)
</pre>

<h4>Tasks Events Subscriptions</h4>

<p>Several task-level events can be used to define actions at task (or
taskgroup) level. See <a href="#task-level-events">Task-Level Events</a>
section below for more details.

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (onsuccess
    # sending UDP packets to statsd server, see https://github.com/etsy/statsd
    (requesturl "task.%!taskid.ok:1|c" (address udp://127.0.0.1:8125))
    (requesturl (address udp://127.0.0.1:8125) "task.%!taskid.time:%!totalms|ms")
    # add a custom debug log for task success
    (log(severity debug) task success! *%!tasklocalid*)
  )
  (onfailure
    # sending UDP packets to statsd
    (requesturl(address udp://127.0.0.1:8125) "task.%!taskid.ko:1|c")
  )
)
</pre>

<h4>Tasks Monitoring</h4>

<p>Whenever a task has a suspect behavior, the scheduler emit an
<a href="#automatic-alerts">automatic alert</a>. For instance when a task
finishes with a failure status.

<p>It's often a good idea to send by e-mail (or any other mean) the automatic
alerts for all or most of the tasks in order to be notified of an issue.
See <a href="#alerts-subscriptions">alerts subscriptions</a> section below.

<p>More automatic alerts are available when setting the following task
parameters:
<ul>
<li><tt>minexpectedduration</tt>: minimum expected task duration in seconds, an
alert will be raised otherwise, with the pattern <tt>task.tooshort.%!taskid</tt>.
<li><tt>maxexpectedduration</tt>: maximum expected task duration in seconds, an
alert will be raised otherwise, with the pattern <tt>task.toolong.%!taskid</tt>.
<li><tt>maxdurationbeforeabort</tt>: duration above which the scheduler will
<a href="#actions-performed-by-an-operator">abort</a> a running task,
this is useful for certain kind of tasks that should better be killed that take
too much time (a nightly purge that can disrupt normal daily processing, a
periodic task running every minutes that should rather be killed when frozen
after 3 minutes rather than keep disable next executions forever, etc.) but is
dangerous in many other cases since aborting is quite hard (kill for local and
ssh execution means, close for http execution mean).
</ul>

<p>Task duration is the time elapsed between the queuing of a task request and
the finishing of its execution.

<p>Sample configuration file fragments:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (minexpectedduration 10) # below 10" there is a issue with data selected
  (maxexpectedduration 3600) # 1 hour
)
</pre>
<pre>
(task process-last-orders
  (taskgroup app1.biz.queuing)
  (trigger(cron /30 * 8-20 * * *)) # twice a minute
  (maxexpectedduration 20)
  (maxdurationbeforeabort 300) # 5 minutes
)
</pre>

<h4>Tasks Request Forms</h4>

<p>When a user task execution request is submited interactively through the
<a href="#wui">web user interface</a> (or, when it will be available, the
desktop/phone user interface) it is possible to display a custom
form to ask the user which <a href="#tasks-parameters">parameters</a> he
would like to override.

<p>A request form is described in the configuration file using a
<tt>requestform</tt> element within a task declaration. It contains one
<tt>field</tt> elements per form field, which itself can contain
the following optional elements:
<ul>
<li><tt>label</tt>: user interface label (field title)
<li><tt>placeholder</tt>: user interface hint (<tt>placeholder</tt> attribute
of <tt>input</tt> HTML element)
<li><tt>suggestion</tt>: default value
<li><tt>format</tt>: validation regular expression (for the web user interface,
the validation is enforced server-side)
</ul>

<p>Sample configuration file fragment:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (command "/opt/app1/bin/build_reports.sh --customers --from %from
     %{=switch:%dryrun:true:--dryrun:}")
  (param from -2days) # regular param value
  (requestform
    (field from # can be overriden when the task is started from the web ui
      (label Data depth) # ui label
      (placeholder -2days) # ui placeholder/hint
      (format "-[0-9]+days") # server side validation regexp
    )
    (field dryrun
      (label Dry run)
      (suggestion false) # default value in ui form
      (format "true|false")
    )
  )
)
</pre>

<h3>Workflows and Subtasks</h2>

<h2>Infrastructure</h2>

<h3>Hosts</h3>

<h3>Clusters</h3>

<h2>Logs</h2>

<h2>Alerts</h2>

<h3>Raisable Alerts</h3>

<h3>Emitted Alerts</h3>

<h3 id="alerts-subscriptions">Subscriptions</h3>

<h3>Automatic Alerts</h3>

<h3>Gridboards</h3>

<h3 id="alerts-fine-tuning">Fine Tuning</h3>

<h3>Custom Alerts</h3>

TODO: custom alerts through events and actions, but also from outside qron using the REST API

<h2>Events and Actions</h2>

<p>Some events can be subscribed at <a href="#task-level-events">task level</a>
or <a href="#scheduler-level-events">scheduler level</a> to make the scheduler
perform one or several <a href="#actions">actions</a>. Events and actions are
described below.

<h3>Task-Level Events</h3>

<p>At task (and taskgroup) level, the following events can be subscribed:
<ul>
<li><tt>onstart</tt>: occurs just before a task begin to run
<li><tt>onsuccess</tt>: occurs just after a task finished with a successful
status
<li><tt>onfailure</tt>: occurs just after a task finished with a failure
status
<li><tt>onfinish</tt>: short for <tt>onsuccess</tt> and <tt>onfailure</tt>
</ul>

<p>Sample configuration file fragment:
<pre>
(task build-reports-customers
  (taskgroup app1.biz.batch)
  (onsuccess
    # sending UDP packets to statsd server, see https://github.com/etsy/statsd
    (requesturl "task.%!taskid.ok:1|c" (address udp://127.0.0.1:8125))
    (requesturl (address udp://127.0.0.1:8125) "task.%!taskid.time:%!totalms|ms")
    # add a custom debug log for task success
    (log(severity debug) task success! *%!tasklocalid*)
  )
  (onfailure
    # sending UDP packets to statsd
    (requesturl(address udp://127.0.0.1:8125) "task.%!taskid.ko:1|c")
  )
)
</pre>

<h3>Scheduler-Level Events</h3>

<p>At scheduler (global) level, the following events can be subscribed:
<ul>
<li><tt>onschedulerstart</tt>: occurs when qron daemon starts
<li><tt>onconfigload</tt>: occurs whenever qron daemon activate a new
configuration, including at startup
<li><tt>onnotice</tt>: occurs whenever a <a href="#notices">notice</a> is
posted
<li><tt>onlog</tt>: occurs whenever a log entry is recorded, this event is
obviously only available for debuging purposes, using it on real-world
live systems is not advisable
<li>every <a href="#task-level-events">task-level events</a> can also be
subscribed at scheduler level, they will be applicable to every task
</ul>

<p>Sample configuration file fragment:
<pre>
(config
  # emit an alert to warn of a configuration (re)load
  (onconfigload (emitalert config.reload))
  # send UDP packets to statsd server on every task success or failure,
  # see https://github.com/etsy/statsd
  (onsuccess
    (requesturl "task.%!taskid.ok:1|c" (address udp://127.0.0.1:8125))
    (requesturl (address udp://127.0.0.1:8125) "task.%!taskid.time:%!totalms|ms")
  )
  (onfailure
    (requesturl(address udp://127.0.0.1:8125) "task.%!taskid.ko:1|c")
  )
)
</pre>

<h3>Actions</h3>

<p>Here are the actions that can be performed when an <tt>event</tt> occurs:
<ul>
<li><tt>postnotice</tt>: post a <a href="#notices">notice</a>
<li><tt>raisealert</tt>: raise a <a href="#raisable-alerts">raisable alert</a>
<li><tt>cancelalert</tt>: cancel a raisable alert
<li><tt>emitalert</tt>: emit an <a href="#emitted-alerts">emitted alert</a>
<li><tt>requesttask</tt>: request task execution
<li><tt>requesturl</tt>: request a network action by url, currently only UDP
and HTTP are supported
<li><tt>log</tt>: add an entry to <a href="#logs">centralized log</a>
<li><tt>step</tt>: activate another step, only available within a
<a href="#workflows-and-subtasks">workflow task</a>
<li><tt>end</tt>: ends the workflow, only available within a workflow task
</ul>

<p>Sample configuration file fragments:
<pre>
TODO
</pre>
<pre>
TODO
</pre>
<pre>
TODO
</pre>

<h3>Notices</h3>

<p>

<h2>Resources</h2>

<h2>Parameters</h2>

<h2>Configuration Management</h2>

<h2>Operations</h2>

<h3>Task Instances Statuses</h3>

<h3>Actions Performed by an Operator</h3>

<h4>Reloading Configuration</h4>

<h4>Requesting a Task Execution</h4>

<h4>Canceling a Task Request</h4>

<h4>Aborting a Task Execution</h4>

<h4>Disabling a Task</h4>

<h2 id="wui">Web User Interface</h2>

<h2>Appendices</h2>


<p>

        </div>
      </div>
    </div>

<?include:common-scripts.html?>
<script>
anchors.add('.user-manual h2, .user-manual h3, .user-manual h4, .user-manual h5');
/*var paragraphAnchors = new AnchorJS({
  placement: 'left',
  icon: '¶'
});
paragraphAnchors.add('.user-manual p');*/
$('body').scrollspy({ target: '#navbar-manual' });
</script>
<?include:footer.html?>
